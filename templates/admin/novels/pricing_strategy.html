{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}Pricing Strategy â€” {{ book.title }}{% endblock %}

{% block content %}
<div style="max-width:1100px">
  <h1>ğŸ’° Pricing Strategy â€” <em>{{ book.title }}</em></h1>
  <p>Current lifecycle: <strong>{{ book.lifecycle_status }}</strong> | Price: <strong>${{ strategy.current_price_usd }}</strong> | Phase: <strong>{{ strategy.current_phase }}</strong></p>

  {% if messages %}
    {% for msg in messages %}
      <div class="messagelist"><p class="{{ msg.tags }}">{{ msg }}</p></div>
    {% endfor %}
  {% endif %}

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-top:1.5rem">
    <!-- Settings Form -->
    <div style="background:#fff;border:1px solid #ddd;border-radius:6px;padding:1.5rem">
      <h2>âš™ï¸ Strategy Settings</h2>
      <form method="post">
        {% csrf_token %}
        <table class="form-table">
          <tr>
            <th>Current Phase</th>
            <td>
              <select name="current_phase" style="width:100%">
                {% for val, label in strategy.get_current_phase_display|yesno:"" %}{% endfor %}
                <option value="launch" {% if strategy.current_phase == 'launch' %}selected{% endif %}>Launch ($0.99)</option>
                <option value="growth" {% if strategy.current_phase == 'growth' %}selected{% endif %}>Growth ($2.99)</option>
                <option value="mature" {% if strategy.current_phase == 'mature' %}selected{% endif %}>Mature ($3.99)</option>
                <option value="promo"  {% if strategy.current_phase == 'promo'  %}selected{% endif %}>Promo ($0.99)</option>
                <option value="bundle" {% if strategy.current_phase == 'bundle' %}selected{% endif %}>Bundle</option>
              </select>
            </td>
          </tr>
          <tr>
            <th>Current Price (USD)</th>
            <td><input type="number" name="current_price_usd" value="{{ strategy.current_price_usd }}" step="0.01" min="0" max="999.99" style="width:100%"></td>
          </tr>
          <tr>
            <th>Reviews for Growth Transition</th>
            <td><input type="number" name="reviews_threshold_for_growth" value="{{ strategy.reviews_threshold_for_growth }}" min="1" style="width:100%"></td>
          </tr>
          <tr>
            <th>Days in Launch Phase</th>
            <td><input type="number" name="days_in_launch_phase" value="{{ strategy.days_in_launch_phase }}" min="1" style="width:100%"></td>
          </tr>
          <tr>
            <th>Auto-price Enabled</th>
            <td><input type="checkbox" name="auto_price_enabled" {% if strategy.auto_price_enabled %}checked{% endif %}></td>
          </tr>
        </table>
        <div style="margin-top:1rem;display:flex;gap:0.5rem">
          <button type="submit" name="action" value="save" class="button default">ğŸ’¾ Save</button>
          <button type="submit" name="action" value="trigger_auto" class="button">ğŸ”„ Trigger Auto-Transition</button>
          <button type="submit" name="action" value="schedule_promo" class="button">ğŸ“… Schedule Countdown Deal</button>
        </div>
      </form>
    </div>

    <!-- Price History -->
    <div style="background:#fff;border:1px solid #ddd;border-radius:6px;padding:1.5rem">
      <h2>ğŸ“ˆ Price History</h2>
      {% if history %}
        <canvas id="priceChart" height="200"></canvas>
        <table style="width:100%;margin-top:1rem;font-size:0.85rem;border-collapse:collapse">
          <thead><tr style="background:#f8f8f8">
            <th style="padding:4px 8px;text-align:left">Date</th>
            <th style="padding:4px 8px;text-align:left">Price</th>
            <th style="padding:4px 8px;text-align:left">Phase</th>
            <th style="padding:4px 8px;text-align:left">Reason</th>
          </tr></thead>
          <tbody>
          {% for h in history %}
            <tr style="border-top:1px solid #eee">
              <td style="padding:4px 8px">{{ h.date|slice:":10" }}</td>
              <td style="padding:4px 8px">${{ h.price }}</td>
              <td style="padding:4px 8px">{{ h.phase }}</td>
              <td style="padding:4px 8px">{{ h.reason }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p style="color:#999">No price history yet. Changes will be logged here automatically.</p>
      {% endif %}
    </div>
  </div>

  <!-- Phase Roadmap -->
  <div style="background:#fff;border:1px solid #ddd;border-radius:6px;padding:1.5rem;margin-top:1.5rem">
    <h2>ğŸ—ºï¸ KDP Pricing Roadmap</h2>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;text-align:center">
      {% for phase, label, price, desc in phases_roadmap %}
      <div style="border:2px solid {% if strategy.current_phase == phase %}#007bff{% else %}#ddd{% endif %};border-radius:8px;padding:1rem;background:{% if strategy.current_phase == phase %}#e8f4fd{% else %}#fafafa{% endif %}">
        <div style="font-size:1.5rem">{{ label|slice:":2" }}</div>
        <strong>{{ label|slice:"3:" }}</strong><br>
        <span style="font-size:1.2rem;color:#007bff">{{ price }}</span><br>
        <small style="color:#666">{{ desc }}</small>
      </div>
      {% endfor %}
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;text-align:center;margin-top:0.5rem">
      <div style="border:2px solid {% if strategy.current_phase == 'launch' %}#007bff{% else %}#ddd{% endif %};border-radius:8px;padding:1rem;background:{% if strategy.current_phase == 'launch' %}#e8f4fd{% else %}#fafafa{% endif %}">
        <div style="font-size:1.5rem">ğŸš€</div><strong>Launch</strong><br><span style="font-size:1.2rem;color:#007bff">$0.99</span><br><small style="color:#666">First 7 days</small>
      </div>
      <div style="border:2px solid {% if strategy.current_phase == 'growth' %}#007bff{% else %}#ddd{% endif %};border-radius:8px;padding:1rem;background:{% if strategy.current_phase == 'growth' %}#e8f4fd{% else %}#fafafa{% endif %}">
        <div style="font-size:1.5rem">ğŸ“ˆ</div><strong>Growth</strong><br><span style="font-size:1.2rem;color:#007bff">$2.99</span><br><small style="color:#666">After 20+ reviews</small>
      </div>
      <div style="border:2px solid {% if strategy.current_phase == 'mature' %}#007bff{% else %}#ddd{% endif %};border-radius:8px;padding:1rem;background:{% if strategy.current_phase == 'mature' %}#e8f4fd{% else %}#fafafa{% endif %}">
        <div style="font-size:1.5rem">ğŸ’</div><strong>Mature</strong><br><span style="font-size:1.2rem;color:#007bff">$3.99</span><br><small style="color:#666">After 30 days</small>
      </div>
      <div style="border:2px solid {% if strategy.current_phase == 'promo' %}#007bff{% else %}#ddd{% endif %};border-radius:8px;padding:1rem;background:{% if strategy.current_phase == 'promo' %}#e8f4fd{% else %}#fafafa{% endif %}">
        <div style="font-size:1.5rem">ğŸ·ï¸</div><strong>Promo</strong><br><span style="font-size:1.2rem;color:#007bff">$0.99</span><br><small style="color:#666">Every 90 days</small>
      </div>
    </div>
  </div>

  <p style="margin-top:1rem"><a href="{% url 'admin:novels_book_change' book.pk %}">â† Back to Book</a></p>
</div>

{% if chart_dates != '[]' %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
new Chart(document.getElementById('priceChart'), {
  type: 'line',
  data: {
    labels: {{ chart_dates|safe }},
    datasets: [{
      label: 'Price (USD)',
      data: {{ chart_prices|safe }},
      borderColor: '#007bff',
      tension: 0.3,
      fill: false,
    }]
  },
  options: { responsive: true, scales: { y: { beginAtZero: false, min: 0 } } }
});
</script>
{% endif %}
{% endblock %}
